name: Set up

on:
  push:
    branches:
      - release
    tags:
      - v*

jobs:

  # Update version
  version:
    name: 'Update version ðŸ“¦'
    needs: prepare
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository branch release
        uses: actions/checkout@v3
        with:
          ref: release
          fetch-depth: 0

      - name: Update release branch
        run: |
          git fetch --all
          git pull --all

      - name: Git config
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "github-actions"
      
      - name: Use Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Get version of the tag
        run: |
          echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: Print the tag
        run: echo $TAG

      - name: Patch the version using TAG and NPM
        run: |
          npm version $TAG --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV
      
      - name: Print package.json
        run: cat package.json

      - name: Print the version
        run: echo $VERSION
      
      - name: Push version
        run: |
          git add package.json
          git commit -m "Update version"
          git push